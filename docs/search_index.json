[["index.html", "RでGIS はじめに", " RでGIS Kazuki Tamura (@kzktmr) 2021-07-19 はじめに この資料では，Rで地理情報データを扱う方法について，解説します。 "],["01-preparation.html", "1 事前準備 1.1 RとRstudioのインストール 1.2 使用するパッケージについて", " 1 事前準備 1.1 RとRstudioのインストール CRANからRをインストールしてください。 RStudioからRStudio Desktop (Open Source License)をインストールしてください。 1.2 使用するパッケージについて tidyverse sf などを使用する予定です。事前にインストールしておいてください。パッケージのインストールには，RStudioのPackagesパネルからInstallする方法や，コンソールに install.packages(&quot;tidyverse&quot;) と入力する方法がありますが，どちらでも構いません。 "],["02-fundamental.html", "2 GISの基礎知識 2.1 GISデータのフォーマット 2.2 測地系 2.3 地図投影変換", " 2 GISの基礎知識 2.1 GISデータのフォーマット 現在流通しているGISデータのファイル形式のうち，代表的な以下の2つを紹介します。 シェープファイル GeoJSON シェープファイルは現在デファクトスタンダードとなっているGISデータのファイル形式で， ESRI社（ArcGISなどのGIS製品で有名）によって開発・規格化されました。 GeoJSONは，JSON（JavaScript Object Notation）を元に開発されたフォーマットです。 GeoJSONのファイルはテキストファイルなので，テキストエディタで閲覧・編集することも可能です。 2.1.1 Simple Featuresとは Simple Features（正式にはSimple Feature Access）は， GISで使用される点・線・多角形などの幾何学図形からなるGISデータの，コンピュータ内部での保存およびアクセス方法に関する標準規格です。 Open Geospatial Consortium (OGC)とInternational Organization for Standardization (ISO)によって規格化されています。 このSimple FeaturesをRで実現するためのパッケージがsfです。 2.2 測地系 日本の測地系 2.3 地図投影変換 平面直角座標系 2.3.1 EPSGコード 世界の様々な測地系や地図投影法に対して，ユニークなID 番号を振り分けたものです。 International Association of Oil ＆ Gas Producers (IOGP）のGeomatics Committeeによって管理されています。 epsg.org，epsg.io などのサイトでEPSGコードを検索することができます。 "],["10-choropleth.html", "3 コロプレス・マップ（塗り分け地図） 3.1 概要 3.2 データの準備 3.3 地図の描画 3.4 地図投影変換 3.5 統計データによる塗り分け", " 3 コロプレス・マップ（塗り分け地図） 3.1 概要 コロプレスマップ（塗り分け地図）を作成する方法を説明します。 佐賀県の市町村別人口密度の塗り分け地図を作成しましょう。 3.2 データの準備 「佐賀県オープンデータカタログサイト」にある「オープンデータマップ用データセット」を使用します。 男女別人口総数及ひ世帯総数（市町村別） ポリゴン（市町村別） 上記2つのファイル（410004saga.xlsxと410004saga.geojson）をダウンロードしてください。 ワーキングディレクトリの直下にdataフォルダを作成し，ダウンロードしたファイルを保存してください（今後，GISデータはこのフォルダに保存することにしましょう）。 3.3 地図の描画 まず，使用するライブラリを読み込みます。ここでは，tidyverse（地図の描画に使うggplot2ライブラリが含まれています）に加えて，GISデータを扱うライブラリsfを使用します。 library(tidyverse) ## ─ Attaching packages ──────────────────── tidyverse 1.3.1 ─ ## ✓ ggplot2 3.3.5 ✓ purrr 0.3.4 ## ✓ tibble 3.1.2 ✓ dplyr 1.0.7 ## ✓ tidyr 1.1.3 ✓ stringr 1.4.0 ## ✓ readr 1.4.0 ✓ forcats 0.5.1 ## ─ Conflicts ───────────────────── tidyverse_conflicts() ─ ## x dplyr::filter() masks stats::filter() ## x dplyr::lag() masks stats::lag() library(sf) ## Linking to GEOS 3.8.1, GDAL 3.2.1, PROJ 7.2.1 次に，先ほどdataフォルダに保存した410004saga.geojsonを， sfライブラリのst_read関数を使って読み込みます。 map &lt;- st_read(&quot;data/410004saga.geojson&quot;) ## Reading layer `410004saga&#39; from data source ## `/Users/kazukitamura/github/giswithr/data/410004saga.geojson&#39; ## using driver `GeoJSON&#39; ## Simple feature collection with 20 features and 4 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: 129.7368 ymin: 32.95054 xmax: 130.5424 ymax: 33.6189 ## Geodetic CRS: WGS 84 読み込んだmapデータをプロットします。 ggplot() + geom_sf(data = map) できました。簡単ですね。 3.4 地図投影変換 先ほど表示された佐賀県の地図は，横軸に経度を，縦軸に緯度をとった平面にプロットしたものでした。 これを「平面直角座標系」に変換して，表示してみましょう。 map2 &lt;- st_transform(map, 6670) ggplot() + geom_sf(data = map2) 微妙な違いがわかりますか？ 3.5 統計データによる塗り分け まず，利用する統計データを読み込み，中身を確認してみましょう。 Excelファイルを読み込むのに，readxlライブラリのread_excel関数を使います。 library(readxl) dat &lt;- read_excel(&quot;data/410004saga.xlsx&quot;) head(dat, 3) ## # A tibble: 3 x 6 ## KEY_CODE 人口総数 市区町村 ` 男` ` 女` 世帯総数 ## &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 412015 236372 佐賀市 111453 124919 93306 ## 2 412023 122785 唐津市 57547 65238 43872 ## 3 412031 72902 鳥栖市 34799 38103 27630 ここで，先ほど地図を描くのに使ったデータの中身もみてみましょう。 head(map2, 3) ## Simple feature collection with 3 features and 4 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: -117268.6 ymin: -1173.744 xmax: -54075.69 ymax: 69215.3 ## Projected CRS: JGD2011 / Japan Plane Rectangular CS II ## KEN_NAME GST_NAME CSS_NAME KEY_CODE geometry ## 1 佐賀県 鹿島市 &lt;NA&gt; 412074 MULTIPOLYGON (((-82226.11 3... ## 2 佐賀県 唐津市 &lt;NA&gt; 412023 MULTIPOLYGON (((-106350 451... ## 3 佐賀県 神埼市 &lt;NA&gt; 412104 MULTIPOLYGON (((-60455.97 2... 両方のデータにKEY_CODEという同じデータがあるのがわかります。 これをキーにして，2つのデータを結合します。 dat2 &lt;- left_join(map2, dat) ## Joining, by = &quot;KEY_CODE&quot; head(dat2) ## Simple feature collection with 6 features and 9 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: -117268.6 ymin: -1173.744 xmax: -54075.69 ymax: 69215.3 ## Projected CRS: JGD2011 / Japan Plane Rectangular CS II ## KEN_NAME GST_NAME CSS_NAME KEY_CODE 人口総数 市区町村 男 女 世帯総数 ## 1 佐賀県 鹿島市 &lt;NA&gt; 412074 29684 鹿島市 13920 15764 10124 ## 2 佐賀県 唐津市 &lt;NA&gt; 412023 122785 唐津市 57547 65238 43872 ## 3 佐賀県 神埼市 &lt;NA&gt; 412104 31842 神埼市 15172 16670 10913 ## 4 佐賀県 杵島郡 江北町 414247 9583 江北町 4497 5086 3225 ## 5 佐賀県 多久市 &lt;NA&gt; 412040 19749 多久市 9146 10603 6847 ## 6 佐賀県 東松浦郡 玄海町 413879 5902 玄海町 3035 2867 1918 ## geometry ## 1 MULTIPOLYGON (((-82226.11 3... ## 2 MULTIPOLYGON (((-106350 451... ## 3 MULTIPOLYGON (((-60455.97 2... ## 4 MULTIPOLYGON (((-78005.98 2... ## 5 MULTIPOLYGON (((-76464.8 27... ## 6 MULTIPOLYGON (((-106304.2 5... このように，対応する2つのデータを結合するときには，dplyrライブラリのleft_join関数が便利です。この関数が2つのデータに共通の列名を自動的に見つけて，そのデータに基づいて2つのデータを結合してくれます。これで，地図データに人口や世帯数のデータを結びつけることができました。 この章の目的は，人口密度のコロプレスマップを作ることですので，市町村の面積データが必要です。先ほどと同様に，別のところから面積データを持ってきでjoinしてもいいのですが，ここでは地図データから面積を計算してみましょう。sfライブラリのst_area関数を使います。 dat2$area &lt;- st_area(dat2) dat2$area &lt;- units::set_units(dat2$area, km^2) dat2$area &lt;- units::drop_units(dat2$area) dat2$density &lt;- dat2$人口総数 / dat2$area head(dat2) ## Simple feature collection with 6 features and 11 fields ## Geometry type: MULTIPOLYGON ## Dimension: XY ## Bounding box: xmin: -117268.6 ymin: -1173.744 xmax: -54075.69 ymax: 69215.3 ## Projected CRS: JGD2011 / Japan Plane Rectangular CS II ## KEN_NAME GST_NAME CSS_NAME KEY_CODE 人口総数 市区町村 男 女 世帯総数 ## 1 佐賀県 鹿島市 &lt;NA&gt; 412074 29684 鹿島市 13920 15764 10124 ## 2 佐賀県 唐津市 &lt;NA&gt; 412023 122785 唐津市 57547 65238 43872 ## 3 佐賀県 神埼市 &lt;NA&gt; 412104 31842 神埼市 15172 16670 10913 ## 4 佐賀県 杵島郡 江北町 414247 9583 江北町 4497 5086 3225 ## 5 佐賀県 多久市 &lt;NA&gt; 412040 19749 多久市 9146 10603 6847 ## 6 佐賀県 東松浦郡 玄海町 413879 5902 玄海町 3035 2867 1918 ## geometry area density ## 1 MULTIPOLYGON (((-82226.11 3... 111.11309 267.1512 ## 2 MULTIPOLYGON (((-106350 451... 487.16068 252.0421 ## 3 MULTIPOLYGON (((-60455.97 2... 124.00616 256.7776 ## 4 MULTIPOLYGON (((-78005.98 2... 24.83140 385.9226 ## 5 MULTIPOLYGON (((-76464.8 27... 96.67014 204.2927 ## 6 MULTIPOLYGON (((-106304.2 5... 35.90699 164.3691 平面直角座標系の距離がm単位になっていますので，st_areaで計算した面積はm2単位になっています。 そこで，unitsライブラリのset_units関数で，km2単位に変換しています。 さらに，人口密度を計算するときに単位が邪魔なので，drop_units関数で単位を落としています。 さて，塗り分け地図を描くには，geom_sfの中で，densityでfillしろと指示するだけです。 2行目は塗り潰しの色（カラーパレット）を指定しています。 ggplot() + geom_sf(mapping = aes(fill = density), data = dat2) + colorspace::scale_fill_continuous_sequential(&quot;YlGn&quot;) "],["20-distance.html", "4 地点間の距離 4.1 概要 4.2 データの準備 4.3 距離の計算 4.4 結果の図示", " 4 地点間の距離 4.1 概要 この章では，GISデータを用いて地点間の距離（直線距離・大圏距離）を測る方法を説明します。 佐賀県庁から，佐賀県の各市役所・町役場までの距離を求めてみましょう。 4.2 データの準備 市町の座標データは，国土交通省の「国土数値情報ダウンロードサービス」で提供されているシェープファイルを使います。 「3.地域」「施設」にある「市区町村役場」から，佐賀県のデータをダウンロードしてください。 ダウンロードしたzipファイルを解凍し，できたP34-14_41_GMLフォルダごとdataフォルダに入れてください。 このように，GeoJSONと異なり，シェープファイルは複数のファイルから構成されていることがわかります。 さて，このデータを読み込むのも，st_read関数です。 関数の引数にフォルダを指定すれば，シェープファイルを読み込んでくれます （Windowsで作業する場合は，options引数は必要ないかもしれません）。 city &lt;- st_read(&quot;data/P34-14_41_GML/&quot;, options = &quot;ENCODING=cp932&quot;) ## options: ENCODING=cp932 ## Reading layer `P34-14_41&#39; from data source ## `/Users/kazukitamura/github/giswithr/data/P34-14_41_GML&#39; using driver `ESRI Shapefile&#39; ## Simple feature collection with 65 features and 4 fields ## Geometry type: POINT ## Dimension: XY ## Bounding box: xmin: 129.8098 ymin: 32.97388 xmax: 130.5231 ymax: 33.54343 ## Geodetic CRS: JGD2000 head(city, 3) ## Simple feature collection with 3 features and 4 fields ## Geometry type: POINT ## Dimension: XY ## Bounding box: xmin: 130.2775 ymin: 33.2241 xmax: 130.3526 ymax: 33.31179 ## Geodetic CRS: JGD2000 ## P34_001 P34_002 P34_003 P34_004 ## 1 41201 1 佐賀市役所 佐賀市栄町1-1 ## 2 41201 2 諸富支所 佐賀市諸富町大字諸富津1-2 ## 3 41201 2 大和支所 佐賀市大和町大字尼寺1870 ## geometry ## 1 POINT (130.3008 33.26354) ## 2 POINT (130.3526 33.2241) ## 3 POINT (130.2775 33.31179) 読み込んだデータの中身を見ると，P34_001からP34_004までのデータ列と，位置情報であるgeometry列があることがわかります。 P34から始まるデータ列の意味を知りたい場合は，先ほどのウェブページの「属性情報」欄をご覧ください。 順番に「行政区域コード」「施設分類」「名称」「所在地」のデータであることがわかります。 「施設分類」は，1が「本庁（市役所、区役所、町役場、村役場）」，2が「支所、出張所、連絡所」を意味しますが，今回の作業に必要なのは本庁のデータだけなので，そのデータだけ抜き出します。 これは，dplyrライブラリのfilter関数を使うことで実現できます。 city &lt;- filter(city, P34_002 == 1) head(city, 3) ## Simple feature collection with 3 features and 4 fields ## Geometry type: POINT ## Dimension: XY ## Bounding box: xmin: 129.968 ymin: 33.26354 xmax: 130.5062 ymax: 33.4501 ## Geodetic CRS: JGD2000 ## P34_001 P34_002 P34_003 P34_004 geometry ## 1 41201 1 佐賀市役所 佐賀市栄町1-1 POINT (130.3008 33.26354) ## 2 41202 1 唐津市役所 唐津市西城内1-1 POINT (129.968 33.4501) ## 3 41203 1 鳥栖市役所 鳥栖市宿町1118 POINT (130.5062 33.37776) 次に，佐賀県庁の位置データを準備します。 市町のデータと同じように，国土数値情報などのデータを利用してもよいですが， ここでは，データを手作りしてみましょう。 ウェブブラウザで地理院地図を開き，ページ上部の検索ボックスから「佐賀県庁舎」を検索してください。 検索結果欄から「佐賀県庁舎」をクリックすると，佐賀県庁舎を中心とした地図が表示されますので，さらに画面中央の旗アイコンをクリックすると，佐賀県庁舎の緯度軽度が表示されます。 この緯度軽度の数字から，以下のようにst_sfなどの関数を使って，sfオブジェクトを作成します。 さらに，日本測地系（JGD2000，EPSGコード：4612）を指定します 1。 geometry &lt;- st_sfc(st_point(c(130.2991337, 33.24936696))) pref &lt;- st_sf(name = &quot;佐賀県庁舎&quot;, geometry) st_crs(pref) &lt;- 4612 pref ## Simple feature collection with 1 feature and 1 field ## Geometry type: POINT ## Dimension: XY ## Bounding box: xmin: 130.2991 ymin: 33.24937 xmax: 130.2991 ymax: 33.24937 ## Geodetic CRS: JGD2000 ## name geometry ## 1 佐賀県庁舎 POINT (130.2991 33.24937) 4.3 距離の計算 このように，佐賀県内市町と佐賀県庁の座標データが準備できましたので，距離を計算するわけですが，これはsfライブラリのst_distance関数で求めることができます。 st_distance(city, pref) ## Units: [m] ## [,1] ## [1,] 1584.224 ## [2,] 38005.226 ## [3,] 23962.481 ## [4,] 18109.154 ## [5,] 38944.722 ## [6,] 26768.555 ## [7,] 24704.188 ## [8,] 8080.135 ## [9,] 26010.413 ## [10,] 9684.116 ## [11,] 12225.146 ## [12,] 28680.784 ## [13,] 14156.415 ## [14,] 16715.883 ## [15,] 46557.823 ## [16,] 42088.235 ## [17,] 17481.769 ## [18,] 13576.474 ## [19,] 16349.074 ## [20,] 27902.466 この結果を，単位をkmに直したのち，cityデータのdistance列として距離データを追加します。 dist &lt;- st_distance(city, pref) dist &lt;- units::set_units(dist, km) city$distance &lt;- as.numeric(dist) head(city, 3) ## Simple feature collection with 3 features and 5 fields ## Geometry type: POINT ## Dimension: XY ## Bounding box: xmin: 129.968 ymin: 33.26354 xmax: 130.5062 ymax: 33.4501 ## Geodetic CRS: JGD2000 ## P34_001 P34_002 P34_003 P34_004 geometry ## 1 41201 1 佐賀市役所 佐賀市栄町1-1 POINT (130.3008 33.26354) ## 2 41202 1 唐津市役所 唐津市西城内1-1 POINT (129.968 33.4501) ## 3 41203 1 鳥栖市役所 鳥栖市宿町1118 POINT (130.5062 33.37776) ## distance ## 1 1.584224 ## 2 38.005226 ## 3 23.962481 4.4 結果の図示 佐賀県内市町の，佐賀県庁からの距離と人口密度の関係を散布図にしてみましょう。 まず，人口密度と距離が別々のデータに入っているので，それらを結合します。 結合に使う市町村コードが少し違う（佐賀県オープンデータの市町村コードには6桁目にチェックディジットが入っている）ので，小細工しています。 dat3 &lt;- st_drop_geometry(dat2) dat3$KEY_CODE2 &lt;- str_sub(dat3$KEY_CODE, 1, 5) dat3 &lt;- left_join(dat3, city, by = c(&quot;KEY_CODE2&quot; = &quot;P34_001&quot;)) head(dat3, 3) ## KEN_NAME GST_NAME CSS_NAME KEY_CODE 人口総数 市区町村 男 女 世帯総数 ## 1 佐賀県 鹿島市 &lt;NA&gt; 412074 29684 鹿島市 13920 15764 10124 ## 2 佐賀県 唐津市 &lt;NA&gt; 412023 122785 唐津市 57547 65238 43872 ## 3 佐賀県 神埼市 &lt;NA&gt; 412104 31842 神埼市 15172 16670 10913 ## area density KEY_CODE2 P34_002 P34_003 P34_004 ## 1 111.1131 267.1512 41207 1 鹿島市役所 鹿島市大字納富分2643-1 ## 2 487.1607 252.0421 41202 1 唐津市役所 唐津市西城内1-1 ## 3 124.0062 256.7776 41210 1 神埼市役所 神埼市神埼町神埼410 ## geometry distance ## 1 POINT (130.0986 33.1038) 24.704188 ## 2 POINT (129.968 33.4501) 38.005226 ## 3 POINT (130.3731 33.31073) 9.684116 データができたので，散布図を作成します（Windowsの場合は，family引数は必要ないかもしれません）。 library(ggrepel) ggplot(dat3, aes(x = distance, y = density)) + geom_point() + geom_text_repel(aes(label = 市区町村), family = &quot;HiraginoSans-W3&quot;) ついでに，市町（city）と県庁（pref）の位置を，地図に落としてみましょう。 ggplot() + geom_sf(data = map2) + geom_sf(data = city, color = &quot;blue&quot;) + geom_sf(data = pref, color = &quot;red&quot;) 細かいことを言えば，地理院地図の測地系はJGD2011なのですが，西日本地域では両者に差がないので，国土数値情報のデータに合わせて，JDG2000にしておきます。↩︎ "]]
